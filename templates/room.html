<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Clueless</title>
    {% load static %}
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="{% static 'room.css' %}">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
  <a class="navbar-brand" href="#">
    <img src="{% static "ctrl.png" %}" height="30" alt="My image">
    <img src="{% static "defeat.png" %}" height="30" alt="My image">
  </a>
  </nav>
  <div class="row">
    <div class="col-9">
      <div class="card">
        <div class="card-body">
    <div class="character-grid">
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <h6 style="color:black">Choose your character</h6></br>
        <button class="btn btn-success btn-sm" type="button" value="start"
        onClick="startGame()">Start</button></br></br>
        <button class="btn btn-danger btn-sm" id="end-game-button" value="End Turn"
        onClick="endTurn()">End Turn</button>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "colonelmustard.png" %}" height="120"
        onClick="chooseCharacter('colonel-mustard')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="colonel-mustard" type="button" value="played by"
         onClick="chooseCharacter('colonel-mustard')">
        played by</button> -->
        <div class='character' id="colonel-mustard-who"></div>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "professorplum.png" %}" height="120"
        onClick="chooseCharacter('professor-plum')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="professor-plum"
          type="button"
          value="played by"
          onClick="chooseCharacter('professor-plum')">
         played by</button> -->
        <div class='character' id="professor-plum-who"></div>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "mrgreen.png" %}" height="120"
        onClick="chooseCharacter('mr-green')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="mr-green"
          type="button"
          value="played by"
          onClick="chooseCharacter('mr-green')">
         played by</button> -->
        <div class='character' id="mr-green-who"></div>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "mrspeacock.png" %}" height="120"
        onClick="chooseCharacter('mrs-peacock')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="mrs-peacock" type="button" value="played by"
        onClick="chooseCharacter('mrs-peacock')">
       played by</button> -->
        <div class='character' id="mrs-peacock-who"></div>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "missscarlet.png" %}" height="120"
        onClick="chooseCharacter('miss-scarlet')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="miss-scarlet" type="button" value="played by"
        onClick="chooseCharacter('miss-scarlet')">
       played by</button> -->
        <div class='character' id="miss-scarlet-who"></div>
      </div>
      <div class='character-grid-item' style="margin:5px;padding:5px;color:black;">
        <img src="{% static "mrswhite.png" %}" height="120"
        onClick="chooseCharacter('mrs-white')"><br/>
        <!-- <button class="btn btn-primary btn-sm" id="mrs-white" type="button" value="played by"
        onClick="chooseCharacter('mrs-white')">
       played by</button> -->
        <div class='character' id="mrs-white-who"></div>
      </div>
    </div>
  </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class='card-grid'>
            <div class='card-grid-item' style="margin:5px;padding:5px;">
              <h6 id="hands">Cards in your hand<br/></h6>
            </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand0pic"></div>
                <a id="hand0"></a>
              </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand1pic"></div>
                <a id="hand1"></a>
              </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand2pic"></div>
                <a id="hand2"></a>
              </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand3pic"></div>
                <a id="hand3"></a>
              </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand4pic"></div>
                <a id="hand4"></a>
              </div>
              <div class='card-grid-item' style="margin:5px;padding:5px;">
                <div id="hand5pic"></div>
                <a id="hand5"></a>
              </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="grid-container">
          <div class="grid-item" onClick="chooseLocation('study')">
            <img src="{% static "studymap.png" %}">
            <!-- Study -->
          <div class='room' id="study-who"></div>
          <!-- <input id="study" type="button" value="move"
          onClick="chooseLocation('study')"/> -->
          <div>↘</div>
          </div>
          <div class='grid-item-hallway' onClick="chooseLocation('hallway1')">
            =
          <div class='room' id="hallway1-who"></div>
          <!-- <input id="hallway1" type="button" value="move"
          onClick="chooseLocation('hallway1')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('hall')">
            <img src="{% static "hallmap.png" %}">
          <!-- Hall -->
          <div class='room' id="hall-who"></div>
          <!-- <input id="hall" type="button" value="move"
          onClick="chooseLocation('hall')"/> -->
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway2')">
          =
          <div class='room' id="hallway2-who"></div>
          <!-- <input id="hallway2" type="button" value="move"
          onClick="chooseLocation('hallway2')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('lounge')">
            <img src="{% static "loungemap.png" %}">
          <!-- Lounge -->
          <div class='room' id="lounge-who"></div>
          <!-- <input id="lounge" type="button" value="move"
          onClick="chooseLocation('lounge')"/> -->
          <div>↙</div>
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway3')">
          ||
          <div class='room' id="hallway3-who"></div>
          <!-- <input id="hallway3" type="button" value="move"
          onClick="chooseLocation('hallway3')"/> -->
          </div>
          <div class="grid-item-block"></div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway4')">
          ||
          <div class='room' id="hallway4-who"></div>
          <!-- <input id="hallway4" type="button" value="move"
          onClick="chooseLocation('hallway4')"/> -->
          </div>
          <div class="grid-item-block"></div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway5')">
          ||
          <div class='room' id="hallway5-who"></div>
          <!-- <input id="hallway5" type="button" value="move"
          onClick="chooseLocation('hallway5')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('library')">
            <img src="{% static "librarymap.png" %}">
          <!-- Library -->
          <div class='room' id="library-who"></div>
          <!-- <input id="library" type="button" value="move"
          onClick="chooseLocation('library')"/> -->
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway6')">
          =
          <div class='room' id="hallway6-who"></div>
          <!-- <input id="hallway6" type="button" value="move"
          onClick="chooseLocation('hallway6')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('billiardroom')">
            <img src="{% static "billiardroommap.png" %}">
          <!-- Billiard Room -->
          <div class='room' id="billiardroom-who"></div>
          <!-- <input id="billiardroom" type="button" value="move"
          onClick="chooseLocation('billiardroom')"/> -->
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway7')">
          =
          <div class='room' id="hallway7-who"></div>
          <!-- <input id="hallway7" type="button" value="move"
          onClick="chooseLocation('hallway7')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('diningroom')">
            <img src="{% static "diningroommap.png" %}">
          <!-- Dining Room -->
          <div class='room' id="diningroom-who"></div>
          <!-- <input id="diningroom" type="button" value="move"
          onClick="chooseLocation('diningroom')"/> -->
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway8')">
          ||
          <div class='room' id="hallway8-who"></div>
          <!-- <input id="hallway8" type="button" value="move"
          onClick="chooseLocation('hallway8')"/> -->
          </div>
          <div class="grid-item-block"></div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway9')"/>
          ||
          <div class='room' id="hallway9-who"></div>
          <!-- <input id="hallway9" type="button" value="move"
          onClick="chooseLocation('hallway9')"/> -->
          </div>
          <div class="grid-item-block"></div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway10')">
          |&nbsp;&nbsp;&nbsp;&nbsp;|
          <div class='room' id="hallway10-who"></div>
          <!-- <input id="hallway10" type="button" value="move"
          onClick="chooseLocation('hallway10')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('conservatory')">
            <img src="{% static "conservatorymap.png" %}">
          <!-- Conservatory -->
          <div class='room' id="conservatory-who"></div>
          <!-- <input id="conservatory" type="button" value="move"
          onClick="chooseLocation('conservatory')"/> -->
          <div>↗</div>
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway11')">
          <br/>_<div class='room' id="hallway11-who"></div>_
          <div class='room' id="hallway11-who"></div>
          <!-- <input id="hallway11" type="button" value="move"
          onClick="chooseLocation('hallway11')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('ballroom')">
            <img src="{% static "ballroommap.png" %}">
          <!-- Ballroom -->
          <div class='room' id="ballroom-who"></div>
          <!-- <input id="ballroom" type="button" value="move"
          onClick="chooseLocation('ballroom')"/> -->
          </div>
          <div class="grid-item-hallway" onClick="chooseLocation('hallway12')">
          <br/>_<div class='room' id="hallway12-who"></div>_
          <div class='room' id="hallway12-who"></div>
          <!-- <input id="hallway12" type="button" value="move"
          onClick="chooseLocation('hallway12')"/> -->
          </div>
          <div class="grid-item" onClick="chooseLocation('kitchen')">
            <img src="{% static "kitchenmap.png" %}">
          <!-- Kitchen -->
          <div class='room' id="kitchen-who"></div>
          <!-- <input id="kitchen" type="button" value="move"
          onClick="chooseLocation('kitchen')"/> -->
          <div>↖</div>
          </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <table>
            <tr>
              <td width="7%">Subjects</td>
              <td width="13%">Colonel Mustard <input type="checkbox" size="10"/></td>
              <td width="12%">Professor Plum <input type="checkbox" size="10"/></td>
              <td width="10%">Mr Green <input type="checkbox" size="10"/></td>
              <td width="11%">Mrs Peacock <input type="checkbox" size="10"/></td>
              <td width="11%">Miss Scarlet <input type="checkbox" size="10"/></td>
              <td width="11%">Mrs White <input type="checkbox" size="10"/></td>
            </tr>
            <tr>
              <td>Weapons</td>

              <td>Candlestick <input type="checkbox" size="10"/></td>

              <td>Revolver <input type="checkbox" size="10"/></td>

              <td>Knife <input type="checkbox" size="10"/></td>

              <td>Lead Pipe <input type="checkbox" size="10"/></td>

              <td>Rope <input type="checkbox" size="10"/></td>

              <td>Wrench <input type="checkbox" size="10"/></td>
            </tr>
            <tr>
              <td>Rooms</td>
              <td>Study <input type="checkbox" size="10"/></td>

              <td>Hall <input type="checkbox" size="10"/></td>

              <td>Lounge <input type="checkbox" size="10"/></td>

              <td>Library <input type="checkbox" size="10"/></td>

              <td>Billiard Room <input type="checkbox" size="10"/></td>

              <td>Dining Room <input type="checkbox" size="10"/></td>

              <td width="11%">Conservatory <input type="checkbox" size="10"/></td>

              <td width="8%">Ballroom <input type="checkbox" size="10"/></td>

              <td>Kitchen <input type="checkbox" size="10"/></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="col-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Chat and Notification</h5>
          <div>
            <textarea id="chat-log" cols="50" rows="25"></textarea>
            <br/>
            <select id="chat-to">
              <option value="all">all</option>
              <!-- <option value="king">king</option>
              <option value="justin">justin</option>
              <option value="bryan">bryan</option>
              <option value="taylor">taylor</option> -->
            </select>
            <!-- <input id="chat-to" type="text" size="5"> -->
            <input id="chat-message-input" type="text" size="20">
            <input id="chat-message-submit" type="button" value="Send" onClick='sendMessageByButton()'/>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Suggestion</h5>
          <div>
            Choose the character:
            <select id='suggestion-character'>
              <option value="colonel-mustard">Colonel Mustard</option>
              <option value="professor-plum">Professor Plum</option>
              <option value="mr-green">Mr Green</option>
              <option value="mr-speacock">Mrs Peacock</option>
              <option value="miss-scarlet">Miss Scarlet</option>
              <option value="mrs-white">Mrs White</option>
            </select><br/>
            Choose the weapon:
            <select id='suggestion-weapon'>
              <option value="candlestick">Candlestick</option>
              <option value="revolver">Revolver</option>
              <option value="knife">Knife</option>
              <option value="leadpipe">Lead Pipe</option>
              <option value="rope">Rope</option>
              <option value="wrench">Wrench</option>
            </select><br/>
            Choose the room:
            <select id='suggestion-room'>
              <option value="study">Study</option>
              <option value="kitchen">Kitchen</option>
              <option value="ballroom">Ballroom</option>
              <option value="conservatory">Conservatory</option>
              <option value="billiard">Billiard Room</option>
              <option value="library">Library</option>
              <option value="lounge">Lounge</option>
              <option value="dining">Dining Room</option>
              <option value="hall">Hall</option>
            </select><br/><br/>
            <button class="btn btn-primary btn-sm" id="suggestion" type="button" value="Submit"
            onclick="sendSuggestion('suggestion-room',
              'suggestion-weapon', 'suggestion-character')">Suggest</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Accusation</h5>
          <div>
            Choose the character:
            <select id='accusation-character'>
              <option value="colonelmustard">Colonel Mustard</option>
              <option value="professorplum">Professor Plum</option>
              <option value="mrgreen">Mr Green</option>
              <option value="mrspeacock">Mrs Peacock</option>
              <option value="missscarlet">Miss Scarlet</option>
              <option value="mrswhite">Mrs White</option>
            </select><br/>
            Choose the weapon:
            <select id='accusation-weapon'>
              <option value="candlestick">Candlestick</option>
              <option value="revolver">Revolver</option>
              <option value="knife">Knife</option>
              <option value="leadpipe">Lead Pipe</option>
              <option value="rope">Rope</option>
              <option value="wrench">Wrench</option>
            </select><br/>
            Choose the room:
            <select id='accusation-room'>
              <option value="study">Study</option>
              <option value="kitchen">Kitchen</option>
              <option value="ballroom">Ballroom</option>
              <option value="conservatory">Conservatory</option>
              <option value="billiard">Billiard Room</option>
              <option value="library">Library</option>
              <option value="lounge">Lounge</option>
              <option value="dining">Dining Room</option>
              <option value="hall">Hall</option>
            </select><br/><br/>
            <button class="btn btn-danger btn-sm" id="Accusation" type="button" value="Submit"
            onclick="checkAccusation('accusation-character',
              'accusation-weapon', 'accusation-room')">Claim</button>
        </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <div id='secret-card-item' class='secret-card-item'></div>
</body>
<script>
    var parts = window.location.href.split('/');
    var roomName = parts[4];
    var username = parts[5];
    var to = '';

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName +'/' + username + '/');

    var gameSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/game/' + roomName +'/' + username + '/');
    var subjects = ['colonelmustard','professorplum','mrgreen','mrspeacock','missscarlet','mrswhite'];
    var weapons = ['candlestick','revolver','knife','leadpipe','rope','wrench'];
    var rooms	=['study', 'hall', 'lounge','library', 'billiardroom',
    'diningroom', 'conservatory', 'ballroom', 'kitchen'];
    // var orderList = ["missscarlet", "colonelmustard", "mrswhite", "mrgreen", "mrspeacock", "professorplum"];

    var secretCards = {
      'character': subjects[Math.floor(Math.random()* 6)],
      'weapon': weapons[Math.floor(Math.random()*6)],
      'room': rooms[Math.floor(Math.random()*9)],
    };

    var paths = {
      'study': ['hallway1', 'hallway3', 'kitchen'],
      'hallway1': ['study', 'hall'],
      'hall': ['hallway1', 'hallway2', 'hallway4'],
      'hallway2':['hall', 'lounge'],
      'lounge': ['hallway2', 'conservatory', 'hallway5'],
      'hallway3': ['study', 'library'],
      'hallway4': ['hall', 'billiardroom'],
      'hallway5': ['lounge', 'diningroom'],
      'library': ['hallway3', 'hallway6', 'hallway8'],
      'hallway6': ['library', 'billiard'],
      'billiardroom': ['hallway6', 'hallway4', 'hallway7', 'hallway9'],
      'hallway7': ['billiardroom', 'diningroom'],
      'diningroom': ['hallway7', 'hallway5', 'hallway10'],
      'hallway8': ['library', 'conservatory'],
      'hallway9': ['billiardroom', 'ballroom'],
      'hallway10': ['diningroom', 'kitchen'],
      'conservatory': ['hallway8', 'lounge', 'hallway11'],
      'hallway11': ['conservatory', 'ballroom'],
      'ballroom': ['hallway11', 'hallway9', 'hallway12'],
      'hallway12': ['ballroom', 'kitchen'],
      'kitchen': ['hallway12', 'study', 'hallway10'],
    };

    var formattedNomenLookup = {
      'study': 'Study',
      'hall': 'Hall',
      'lounge': 'Lounge',
      'library': 'Library',
      'billiardroom': 'Billiard Room',
      'diningroom': 'Dining Room',
      'conservatory': 'Conservatory',
      'ballroom': 'Ball Room',
      'kitchen': 'Kitchen',
      'colonel-mustard': 'Colonel Mustard',
      'miss-scarlet':'Miss Scarlet',
      'professor-plum':'Professor Plum',
      'mrs-peacock':'Mrs. Peacock',
      'mr-green':'Mr. Green',
      'mrs-white':'Mrs. White',
      'candlestick':'Candlestick',
      'revolver':'Revolver',
      'knife':'Knife',
      'leadpipe':'Leadpipe',
      'rope':'Rope',
      'wrench':'Wrench',
    };

    var startingPoint = {
      'colonelmustard':'hallway5',
      'missscarlet':'hallway2',
      'professorplum':'hallway3',
      'mrspeacock':'hallway8',
      'mrgreen':'hallway11',
      'mrswhite':'hallway12'
    };

    //turn "class"
    function turnClass(turnNum, turnUser){
        this.turnNum = turnNum;
        this.turnUser = turnUser;
        this.moved = false; //has player moved this turn
        this.suggested = false;
    }

    //instantiate turn, probably unsafe
    var currentTurn = new turnClass(0,''); //completely initialized in startGame
    var playerList; //initialized in startGame, stores users still in the game, also probably unsafe
    var gameStarted = false;

    gameSocket.onmessage = function(e){
      var data = JSON.parse(e.data);
      if (data['command']==='new_location'){
          assignLocation(data);
      }
      if (data['command']==='choose_character'){
          assignCharacter(data);
      }
      if (data['command']==='secret'){
        assignSecret(data);
      }
      if (data['command']==='hands'){
        assignHands(data['hands'][username]);
      }
      if (data['command']==='next_turn'){
        shareData(data);
      }
      if (data['command']==='start_game'){
        initGameVal(data);
      }
      if (data['command']==='wrong_acc'){
        cleanUpPlayer(currentTurn.turnUser);
        shareData(data);
      }
      if (data['command']==='end_game'){
        endGame(data);
      }
    }
    gameSocket.onopen = function(e) {
    }
    gameSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    chatSocket.onopen = function(e) {
      fetchMessages();
    }

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data['command']==='messages'){
          for (let i=0; i<data['messages'].length; i++){
            if (data['messages'][i]['author']==username ||
                data['messages'][i]['to']==username ||
                data['messages'][i]['to']=='' ||
                data['messages'][i]['to']=='all'){
            createMessage(data['messages'][i]);
            }
          }
        } else if (data['command']==='new_message'){
            if (data['message']['author']==username ||
                data['message']['to']==username ||
                data['message']['to']=='' ||
                data['message']['to']=='all'){
              createMessage(data['message']);
            }
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };


    // document.querySelector('#chat-message-submit').onclick = function(e) {
    //     var messageInputDom = document.querySelector('#chat-message-input');
    //     // var chatTo = document.querySelector('#chat-to');
    //     var message = messageInputDom.value;
    //     chatSocket.send(JSON.stringify({
    //         'message': message,
    //         'command': 'new_messages',
    //         'from': username,
    //         'to': to
    //     }));
    //
    //     messageInputDom.value = '';
    // };

    function sendMessageByButton(){
      var messageInputDom = document.querySelector('#chat-message-input');
      var message = messageInputDom.value;
      var toInputDom = document.querySelector('#chat-to');
      var to = toInputDom.value;
      chatSocket.send(JSON.stringify({
          'message': message,
          'command': 'new_messages',
          'from': username,
          'to': to
      }));
      messageInputDom.value = '';
    }

    function sendMessage(message, to){
      chatSocket.send(JSON.stringify({
          'message': message,
          'command': 'new_messages',
          'from': username,
          'to':to
      }));
    }

    function sendMessageFromSystem(message,to){
        chatSocket.send(JSON.stringify({
          'message': message,
          'command': 'new_messages',
          'from': 'SYSTEM',
          'to':to
      }));
    }

    function isAlive(user){
        if(playerList.indexOf(user) == -1){
            return false;
        }
        return true;

    }

    function sendSuggestion(location, weapon, character){
      var weapon = document.getElementById(weapon).value;
      //var room = document.getElementById(location).value;
      var room = currentLocation(username);
      var character = document.getElementById(character).value;
      // if (character_name=='mrspeacock'){
      //   character_name='mrs-peacock';
      // }
      // if (document.querySelector('#'+character_name+'-who').innerHTML !==''){
      //   var character = document.querySelector('#'+character_name+'-who').innerHTML;
      // } else{
      //   var character = document.getElementById(character).value;
      // }

      if(room === currentLocation(username) && !isHallway(currentLocation(username)))
      {
        suggestionUser = document.querySelector('#' + character + '-who').innerHTML;

        if(suggestionUser !== '' && suggestionUser !== username && isAlive(suggestionUser)){
            chooseLocation(room, true, suggestionUser);
        }
        sendMessage('Suggestion - ROOM: ' + formattedNomenLookup[room] + ' |' + ' WEAPON: '+formattedNomenLookup[weapon]+ ' |' + ' CHARACTER: ' + formattedNomenLookup[character], 'all');
        currentTurn.suggested = true;
      }
      else if(isHallway(currentLocation(username)))
      {
        alert(username + ': Can\'t make suggestion because you are in a hallway', 'all');
      }
      else
      {
        alert(username + ': Can\'t make suggestion in ' + formattedNomenLookup[room] + ' because you are not in that room!', 'all');
      }
    }

    function fetchMessages(){
      chatSocket.send(JSON.stringify({'command':'fetch_messages'}));
    }

    function createMessage(data){
      document.querySelector('#chat-log').value += (data.author + ': ' + data.content + '\n');
    }

    function assignLocation(data){
      document.querySelector('#'+data.location+'-who').innerHTML = data.player;
      // if (document.querySelector('#'+data.location+'-who').innerHTML===''){
      //   document.querySelector('#'+data.location+'-who').innerHTML = data.player;
      // } else{
      //   document.querySelector('#'+data.location+'-who').innerHTML += ', '+data.player;
      // }
    }

    function assignCharacter(data){
      document.querySelector('#' + data.character + '-who').innerHTML = data.from;
    }

    function assignSecret(data){
      console.log(JSON.stringify(data));
      document.querySelector('#secret-card-item').innerHTML = JSON.stringify(data);
    }

    function assignHands(data){
      for (var i=0; i<data.length; i++){
        document.querySelector('#hand' + i.toString()).innerHTML = data[i];
      }
    }

    function checkChosenCharacter(){
      var character_list = document.getElementsByClassName('character');
      for (var i=0; i<character_list.length; i++){
        if (character_list[i].innerHTML===username) {
          return true
        }
      }
      return false;
    }

    function getAllPlayers(){
      var player_list = [];
      var character_list = document.getElementsByClassName('character');
      for (var i=0; i<character_list.length; i++){
        if (character_list[i].innerHTML!=='') {
          player_list.push(character_list[i].innerHTML);
        }
      }
      return player_list;
    }

    function checkNumOfPlayers(){
      var numOfPlayers=0;
      var character_list = document.getElementsByClassName('character');
      for (var i=0; i<character_list.length; i++){
        if (character_list[i].innerHTML!=='') {
          numOfPlayers++;
        }
      }
      return numOfPlayers;
    }

    function chooseCharacter(character){
      if (document.querySelector('#'+character+'-who').innerHTML==='' &&
          !checkChosenCharacter()
    ){
        gameSocket.send(JSON.stringify({
            'command': 'choose_character',
            'from': username,
            'character': character
        }));
      } else if(checkChosenCharacter()){
        alert('You have already chosen you character!');
      } else {
        alert('played by someone already!');
      }
    }

    function isHallway(location){
        if(location.includes("hallway")){
            return true;
        }
        else
        {
            return false;
        }
    }

    function sendLocationJson(username, location){
      return gameSocket.send(JSON.stringify({
          'command': 'move',
          'player': username,
          'location':location
      }));
    }

    function nextTurnJson(){
        return gameSocket.send(JSON.stringify({
          'command': 'next_turn'
      }));
    }

    function startGameJson(playerlist){
        return gameSocket.send(JSON.stringify({
          'command': 'start_game',
          'playerlist': playerlist
      }));
    }

    function shareData(data){
        //change local version
        currentTurn.turnNum = data.turn_num;
        currentTurn.turnUser = data.turn_user;
        playerList = data.player_list.split(",");

        if(currentTurn.turnUser === username){
            alert('It is now your turn, ' + username);
        }
        everyoneLostCheck();
    }

    function getUserName(){
      return username;
    }

    function checkIfPlayerCanGotoThatRoom(old_location, new_location){
      return paths[old_location].includes(new_location);
    }

    function locationOtherUser(user){
        var grid_detail = document.getElementsByClassName('room');
      for (var i=0; i<grid_detail.length; i++){
        if (grid_detail[i].innerHTML.includes(user)) {
          return grid_detail[i].id.replace('-who', '');
        }
      }
    }

    function currentLocation(user){
      var grid_detail = document.getElementsByClassName('room');
      for (var i=0; i<grid_detail.length; i++){
        if (grid_detail[i].innerHTML.includes(user)) {
          return grid_detail[i].id.replace('-who', '');
        }
      }
    }

    // function userLocation(suggestion_user){
    //   var grid_detail = document.getElementsByClassName('room');
    //   for (var i=0; i<grid_detail.length; i++){
    //     if (grid_detail[i].innerHTML.includes(suggestion_user)) {
    //       return grid_detail[i].id.replace('-who', '');
    //     }
    //   }
    // }

    function chooseLocation(location, teleport=false, user=getUserName(), suggestion=''){
      if(teleport || (isMyTurn() && !currentTurn.moved)){

      if (teleport){ //movement from a suggestion or wrong accusation
        if (location.substring(0,7)==='hallway'){ //never really used, can't teleport to hallway
          if (document.querySelector('#'+location+'-who').innerHTML===''){
            sendLocationJson(user, location);
          } else {
            alert('Someone is in the hallway already');
          }
        } else{
          if (document.querySelector('#'+location+'-who').innerHTML===''){
            if (document.querySelector('#'+currentLocation(user)+'-who').innerHTML===''){
              sendLocationJson('', currentLocation(user));
              sendLocationJson(user, location);
            } else {
              character_string = document.querySelector('#'+currentLocation(user)+'-who').innerHTML.replace(',','');
              character_string=character_string.replace(user, '');
              sendLocationJson(character_string, currentLocation(user));
              sendLocationJson(user, location);
            }
          } else{
            if (document.querySelector('#'+currentLocation(user)+'-who').innerHTML===''){
              character_string = document.querySelector('#'+location+'-who').innerHTML + ',' + user;
              sendLocationJson('', currentLocation(user));
              sendLocationJson(character_string, location);
            } else {
              //console.log('this scenario');
              character_string = document.querySelector('#'+currentLocation(user)+'-who').innerHTML.replace(',','');
              character_string=character_string.replace(user, '');
              new_character_string = document.querySelector('#'+location+'-who').innerHTML + ',' + user;
              sendLocationJson(character_string, currentLocation(user));
              sendLocationJson(new_character_string, location);
            }
          }
        }
      } else if (checkIfPlayerCanGotoThatRoom(currentLocation(username), location) && !teleport){
        if (location.substring(0,7)==='hallway'){
          if (document.querySelector('#'+location+'-who').innerHTML===''){
            character_string = document.querySelector('#'+currentLocation(username)+'-who').innerHTML.replace(',','');
            character_string=character_string.replace(user, '');
            sendLocationJson(user, location);
            sendLocationJson(character_string, currentLocation(username));
            currentTurn.moved = true;
          } else {
            alert('Someone is in the hallway already');
          }
        } else{
          if (document.querySelector('#'+location+'-who').innerHTML===''){
            if (document.querySelector('#'+currentLocation(username)+'-who').innerHTML===''){
              sendLocationJson('', currentLocation(username));
              sendLocationJson(user, location);
            } else {
              character_string = document.querySelector('#'+currentLocation(username)+'-who').innerHTML.replace(',','');
              character_string=character_string.replace(user, '');
              sendLocationJson(character_string, currentLocation(username));
              sendLocationJson(user, location);
            }
          } else{
            if (document.querySelector('#'+currentLocation(username)+'-who').innerHTML===''){
              character_string = document.querySelector('#'+location+'-who').innerHTML + ',' + user;
              sendLocationJson('', currentLocation(username));
              sendLocationJson(character_string, location);
            } else {
              character_string = document.querySelector('#'+currentLocation(username)+'-who').innerHTML.replace(',','');
              character_string=character_string.replace(user, '');
              new_character_string = document.querySelector('#'+location+'-who').innerHTML + ',' + user;
              sendLocationJson(character_string, currentLocation(username));
              sendLocationJson(new_character_string, location);
            }
          }
          currentTurn.moved = true; //player has made move, can no longer move
        }
      }

      }//end of first if
      else if(!isMyTurn()){
        alert('It is not your turn!');
      }
      else{
        alert('You have already moved this turn!');
      }
    }

    function sendSecretCardsJson(cards){
      return gameSocket.send(JSON.stringify({
          'command': 'secret',
          'character': cards.character,
          'room':cards.room,
          'weapon':cards.weapon
      }));
    }

    function checkAccusation(char,weap,loc) {
      var character = document.getElementById(char).value;
      var weapon = document.getElementById(weap).value;
      var room = document.getElementById(loc).value;
      var answer = JSON.parse(document.querySelector('#secret-card-item').innerHTML);
      sendMessageFromSystem('testonly: ' + answer.character + answer.room + answer.weapon,'all');
      if (answer['character']===character &&answer['weapon']===weapon &&
        answer['room']===room){
          alert('You have won the game');
          winnerJson();
          gameStarted = false;
        }else{
          alert('You lose and are eliminated. You can still watch the game!');
          eliminatePlayerJson();
          currentTurn.moved = false;
          sendMessageFromSystem(username + ' has been eliminated from the game!','all');
          setTimeout(function(){
            sendMessageFromSystem('---------- Starting Game... ----------','all');
            sendMessageFromSystem('Turn: ' + currentTurn.turnNum + ' -- ' + currentTurn.turnUser,'all');
        }, 250);
        }
    }

    //removes current player off of the board, doesn't work currently
    function cleanUpPlayer(user){
        character_string = document.querySelector('#'+currentLocation(user)+'-who').innerHTML.replace(',','');
        character_string=character_string.replace(user, '');
        sendLocationJson(character_string, currentLocation(user));
    }

    //eliminates current player after wrong accusation and increments turn
    function eliminatePlayerJson(){
        return gameSocket.send(JSON.stringify({
          'command': 'wrong_accusation',
          'eliminated': username
      }));
    }

    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
      while (0 !== currentIndex) {

    // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

    // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
      }
      return array;
    }

    function shuffleCardsForHands(){
      var all_cards = subjects.concat(weapons, rooms);
      var secretCardsList = [secretCards['character'], secretCards['weapon'], secretCards['room']]
      var difference = all_cards.filter(x => !secretCardsList.includes(x));
      player_list = getAllPlayers();
      cards_in_each_hands = {};
      for (var i=0; i<player_list.length; i++){
        cards_in_each_hands[player_list[i]]=[];
      }
      for (var j=0; j<difference.length; j++){
        who = j%player_list.length;
        cards_in_each_hands[player_list[who]].push(difference[j]);
      }
      return cards_in_each_hands;
    }

    function sendHandsJson(){
      return gameSocket.send(JSON.stringify({
          'command': 'hands',
          'hands': shuffleCardsForHands()
      }));
    }

    function winnerJson(){
      return gameSocket.send(JSON.stringify({
          'command': 'win',
          'user': username
      }));
    }

    function removeCharacterInOrderList(target){
      orderList.splice(orderList.indexOf(target),1);
      return orderList;
    }

    //returns boolean that tells you if it's your turn or not.
    function isMyTurn(){
        return currentTurn.turnUser === username;
    }

    function nextTurn(){

        currentTurn.moved = false;
        currentTurn.suggested = false;
        nextTurnJson();
        setTimeout(function(){
            sendMessageFromSystem('Turn: ' + currentTurn.turnNum + ' -- ' + currentTurn.turnUser,'all');
        }, 250);
    }

    function endTurn(){
        if(currentTurn.turnUser === username){
            nextTurn();
            alert('You have ended your turn!');
        }
        else{
            alert('It is not your turn!');
        }
        //insert additional processing at end of turn, if needed
    }

    //OBSOLETE: removes current user(player) after wrong accusation. Can only be called by the relevant user on their turn
    function removeUserFromPlayerList(){
        for(var i=0; i < playerList.length; i++){
            if(playerList[i] === username){
                playerList.splice(i,1);
                i--;
            }
        }
    }

    //used to pass arrays into JSON as 1 string, current format: delimited by comma
    function arrayToString(array){
        return array.join();
    }

    function initGameVal(data){
        currentTurn.turnNum = data.turn_num;
        currentTurn.turnUser = data.turn_user;
        //message in chat to indicate started game
    }

    function endGame(data){
        alert(data.winner + ' is the winner! Please refresh to play another game');
        sendMessageFromSystem('---------- Game Over! ----------','all');
    }

    function everyoneLostCheck(){
        if(currentTurn.turnUser == 'none')
            alert('Everyone has lost! Refresh the page to play another game!');
    }

    function startGame(){
        var num_of_players = checkNumOfPlayers();
        //var num_of_players = 3;

        if(num_of_players >= 3 && !gameStarted){
            var character_list = document.getElementsByClassName('character');
            for (var i=0; i<character_list.length; i++){
                if (character_list[i].innerHTML !==''){
                    var location = startingPoint[character_list[i].id.replace('-', '').replace('-who', '')];
                    chooseLocation(location, true, character_list[i].innerHTML);
                }
            }
        sendSecretCardsJson(secretCards);
        sendHandsJson();
        playerList = getAllPlayers(); //first assignment of playerList, players not removable or addable on frontend after
        startGameJson(arrayToString(playerList)); //first turn assignments
        gameStarted = true; //prevent multiple started games on same board
        setTimeout(function(){
            sendMessageFromSystem('---------- Starting Game... ----------','all');
            sendMessageFromSystem('Turn: ' + currentTurn.turnNum + ' -- ' + currentTurn.turnUser,'all');
        }, 250);

        }
        else if(gameStarted){
            alert('Game already started! Finish current game to start a new one');
        }
        else{
            alert('You need more players (3-6)!');
        }

      //
      // if (checkNumOfPlayers() > 2){
      //   alert('Send to consumers to update the starting position');
      // } else{
      //   alert('You need more players!');
      // }
      // alert('there is a function to check num of players, write this function to send to consumers to update the starting position');

    }


    handsPic = {

      'study':"{% static 'study.png' %}",
      'hall':"{% static 'hall.png' %}",
      'lounge':"{% static 'lounge.png' %}",
      'library':"{% static 'library.png' %}",
      'billiardroom':"{% static 'billiardroom.png' %}",
      'diningroom':"{% static 'diningroom.png' %}",
      'conservatory':"{% static 'conservatory.png' %}",
      'ballroom':"{% static 'ballroom.png' %}",
      'kitchen':"{% static 'kitchen.png' %}",
      'colonelmustard':"{% static 'colonelmustard.png' %}",
      'missscarlet':"{% static 'missscarlet.png' %}",
      'professorplum':"{% static 'professorplum.png' %}",
      'mrspeacock':"{% static 'mrspeacock.png' %}",
      'mrgreen':"{% static 'mrgreen.png' %}",
      'mrswhite':"{% static 'mrswhite.png' %}",
      'candlestick':"{% static 'candlestick.png' %}",
      'revolver':"{% static 'revolver.png' %}",
      'knife':"{% static 'knife.png' %}",
      'leadpipe':"{% static 'leadpipe.png' %}",
      'rope':"{% static 'rope.png' %}",
      'wrench':"{% static 'wrench.png' %}",
    }

    function assignHands(data){
      for (var i=0; i<data.length; i++){
        document.querySelector('#hand' + i.toString()).innerHTML = data[i];
        var img=document.createElement("img");
        img.src=handsPic[data[i]];
        img.height="120";
        document.querySelector('#hand' + i.toString()+'pic').appendChild(img);
      }
    }
</script>
</html>
